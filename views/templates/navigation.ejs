<%
  const globalSoftware = Array.isArray(allSoftware) ? allSoftware.filter(software => software && software.globalPlugin) : [];
  const plugins = Array.isArray(myPlugins) ? myPlugins : [];
  const username = loggedIn && user && user.username ? user.username : '';
  const usernameInitial = username ? username.charAt(0).toUpperCase() : 'ðŸ™‚';
%>

<header class="sticky top-0 z-40 border-b border-slate-200 bg-white/90 backdrop-blur">
  <div class="mx-auto flex h-20 max-w-6xl items-center justify-between px-4 sm:px-6">
    <a href="/" class="group flex items-center gap-3">
      <span class="inline-flex h-12 w-12 items-center justify-center rounded-2xl bg-brand-500 font-display text-lg font-semibold text-white shadow-floating transition-transform group-hover:-translate-y-0.5 md:text-xl">
        bS
      </span>
      <span class="flex flex-col leading-tight">
        <span class="font-display text-xl font-semibold text-slate-900 md:text-2xl">bStats</span>
        <span class="text-xs font-medium uppercase tracking-wide text-slate-400">Open source metrics</span>
      </span>
    </a>

    <nav class="hidden items-center gap-6 text-sm font-semibold text-slate-600 md:flex">
      <a href="/plugin-list" class="transition hover:text-slate-900">Plugin List</a>
      <a href="/docs" class="transition hover:text-slate-900">Docs</a>
      <% if (globalSoftware.length) { %>
      <details class="group relative">
        <summary class="flex items-center gap-1 rounded-full bg-slate-100/80 px-3 py-1.5 text-slate-600 transition hover:bg-slate-200 hover:text-slate-900">
          Global Stats
          <svg class="h-4 w-4 transition group-open:rotate-180" viewBox="0 0 20 20" fill="none">
            <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </summary>
        <div class="pointer-events-none invisible absolute left-1/2 top-full z-20 mt-3 w-72 -translate-x-1/2 -translate-y-1 rounded-xl border border-slate-200 bg-white/95 p-3 shadow-2xl opacity-0 transition-all duration-200 group-open:pointer-events-auto group-open:visible group-open:translate-y-0 group-open:opacity-100">
          <ul class="space-y-1.5 text-sm">
            <% globalSoftware.forEach(function(software) { %>
            <li>
              <a href="/global/<%= software.url %>" class="flex items-center justify-between rounded-lg px-3 py-2 text-slate-600 transition hover:bg-brand-50 hover:text-slate-900">
                <span><%= software.name %></span>
                <svg class="h-4 w-4 text-brand-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M13.293 9.293a1 1 0 0 1 1.414 1.414l-4.586 4.586A1 1 0 0 1 8 14.586V6a1 1 0 0 1 2 0v6.172l3.293-3.293z" clip-rule="evenodd" />
                </svg>
              </a>
            </li>
            <% }); %>
          </ul>
          <div class="mt-3 rounded-lg bg-slate-50 p-3 text-xs text-slate-500">
            Curious how it works? Dive into the <a href="/faq" class="font-semibold text-brand-600 hover:text-brand-700">FAQ</a>.
          </div>
        </div>
      </details>
      <% } %>
    </nav>

    <div class="hidden items-center gap-3 md:flex">
      <% if (loggedIn) { %>
      <a href="/add-plugin" class="btn-primary px-5 py-2 text-sm">Add Plugin</a>
      <details class="group relative">
        <summary class="flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-sm font-semibold text-slate-600 transition hover:border-brand-200 hover:text-brand-700">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-brand-100 font-display text-sm font-semibold text-brand-700"><%= usernameInitial %></span>
          <span>Account</span>
          <svg class="h-4 w-4 transition group-open:rotate-180" viewBox="0 0 20 20" fill="none">
            <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </summary>
        <div class="pointer-events-none invisible absolute right-0 top-full z-20 mt-3 w-56 -translate-y-1 rounded-xl border border-slate-200 bg-white/95 p-3 text-sm text-slate-600 shadow-2xl opacity-0 transition-all duration-200 group-open:pointer-events-auto group-open:visible group-open:translate-y-0 group-open:opacity-100">
          <div class="mb-2 rounded-lg bg-slate-50 p-3">
            <p class="text-xs uppercase tracking-wide text-slate-400">Signed in as</p>
            <p class="font-semibold text-slate-700"><%= username || 'bStats user' %></p>
          </div>
          <ul class="space-y-1">
            <li><a href="/author/<%= username %>" class="block rounded-md px-3 py-2 transition hover:bg-brand-50 hover:text-slate-900">My page</a></li>
            <% if (plugins.length) { %>
            <li>
              <p class="px-3 pt-2 text-xs uppercase tracking-wide text-slate-400">My Plugins</p>
              <ul class="mt-2 max-h-40 space-y-1 overflow-y-auto rounded-md bg-slate-50 p-2 text-sm">
                <% plugins.forEach(function(plugin) { %>
                <li>
                  <a href="/plugin/<%= plugin.software.url %>/<%= plugin.name %>" class="block truncate rounded px-2 py-1 transition hover:bg-white hover:text-brand-700">
                    <%= plugin.name %> <span class="text-xs uppercase tracking-wide text-slate-400">(<%= plugin.software.name %>)</span>
                  </a>
                </li>
                <% }); %>
              </ul>
            </li>
            <% } %>
            <li><a href="/change-password" class="block rounded-md px-3 py-2 transition hover:bg-slate-100 hover:text-slate-900">Change password</a></li>
            <li><a href="/logout" class="block rounded-md px-3 py-2 transition hover:bg-slate-100 hover:text-slate-900">Logout</a></li>
          </ul>
        </div>
      </details>
      <% } else { %>
      <a href="/login" class="text-sm font-semibold text-slate-600 transition hover:text-slate-900">Log in</a>
      <a href="/register" class="btn-primary px-5 py-2 text-sm">Create account</a>
      <% } %>
    </div>

    <button type="button" class="inline-flex items-center justify-center rounded-full bg-white p-2 text-slate-600 shadow-sm ring-1 ring-slate-200 transition hover:bg-brand-50 hover:text-brand-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-500 md:hidden" aria-expanded="false" data-mobile-nav-toggle>
      <span class="sr-only">Toggle navigation</span>
      <svg class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    </button>
  </div>

  <div class="mobile-nav hidden border-t border-slate-200 bg-white/95 px-4 py-6 shadow-lg transition md:hidden" data-mobile-nav-panel>
    <div class="mx-auto flex max-w-6xl flex-col gap-6 text-base font-medium text-slate-700">
      <nav class="space-y-3">
        <a href="/plugin-list" class="block rounded-lg px-4 py-3 transition hover:bg-brand-50 hover:text-brand-700">Plugin List</a>
        <a href="/docs" class="block rounded-lg px-4 py-3 transition hover:bg-brand-50 hover:text-brand-700">Docs</a>
        <% if (globalSoftware.length) { %>
        <div class="rounded-2xl bg-slate-100/80 p-4">
          <p class="text-xs uppercase tracking-wide text-slate-400">Global Stats</p>
          <ul class="mt-3 space-y-2 text-sm">
            <% globalSoftware.forEach(function(software) { %>
            <li>
              <a href="/global/<%= software.url %>" class="flex items-center justify-between rounded-lg bg-white px-3 py-2 shadow-sm transition hover:text-brand-700">
                <span><%= software.name %></span>
                <svg class="h-4 w-4 text-brand-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 0 1 0-1.414L10.586 10 7.293 6.707A1 1 0 0 1 8.707 5.293l4 4a1 1 0 0 1 0 1.414l-4 4a1 1 0 0 1-1.414 0Z" clip-rule="evenodd" />
                </svg>
              </a>
            </li>
            <% }); %>
          </ul>
        </div>
        <% } %>
      </nav>

      <div class="space-y-3 rounded-2xl bg-slate-900 px-5 py-6 text-slate-100">
        <p class="text-xs uppercase tracking-wide text-brand-200">Community vibes</p>
        <p class="text-sm text-slate-200">Made for hobbyists, powered by volunteers, and always open source.</p>
      </div>

      <% if (loggedIn) { %>
      <div class="space-y-2">
        <a href="/add-plugin" class="btn-primary w-full justify-center text-base">Add Plugin</a>
        <a href="/author/<%= username %>" class="block rounded-lg border border-slate-200 px-4 py-3 text-center text-sm font-semibold text-slate-600 transition hover:border-brand-300 hover:text-brand-700">My page</a>
        <a href="/change-password" class="block rounded-lg border border-slate-200 px-4 py-3 text-center text-sm font-semibold text-slate-600 transition hover:border-brand-300 hover:text-brand-700">Change password</a>
        <a href="/logout" class="block rounded-lg border border-slate-200 px-4 py-3 text-center text-sm font-semibold text-slate-600 transition hover:border-brand-300 hover:text-brand-700">Logout</a>
        <% if (plugins.length) { %>
        <div class="rounded-2xl bg-slate-100/80 p-4">
          <p class="text-xs uppercase tracking-wide text-slate-400">My Plugins</p>
          <ul class="mt-3 space-y-2 text-sm">
            <% plugins.forEach(function(plugin) { %>
            <li>
              <a href="/plugin/<%= plugin.software.url %>/<%= plugin.name %>" class="block truncate rounded-lg bg-white px-3 py-2 shadow-sm transition hover:text-brand-700">
                <%= plugin.name %> <span class="text-xs uppercase tracking-wide text-slate-400">(<%= plugin.software.name %>)</span>
              </a>
            </li>
            <% }); %>
          </ul>
        </div>
        <% } %>
      </div>
      <% } else { %>
      <div class="flex flex-col gap-3">
        <a href="/login" class="block rounded-lg border border-slate-200 px-4 py-3 text-center text-sm font-semibold text-slate-600 transition hover:border-brand-300 hover:text-brand-700">Log in</a>
        <a href="/register" class="btn-primary w-full justify-center text-base">Create account</a>
      </div>
      <% } %>
    </div>
  </div>
</header>
