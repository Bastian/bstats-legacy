<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Twitter stuff -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@btobastian" />
    <meta name="twitter:title" content="<%= plugin.name %> | bStats" />
    <meta name="twitter:description" content="Statistics about <%= plugin.name %>!" />
    <meta name="twitter:image" content="https://bstats.org/images/Twitter.jpg" />

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="description" content="Some stats about <%= plugin.name %>.">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
    <title>bStats - <%= plugin.name %></title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/stylesheets/main.css" />

    <link rel="stylesheet" type="text/css" href="https://cloud.github.com/downloads/lafeber/world-flags-sprite/flags32.css" />

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
</head>
<body>
<% include templates/navigation.ejs %>

<main class="pb-24">
    <section class="relative overflow-hidden border-b border-slate-200 bg-gradient-to-br from-brand-50 via-white to-sky-100">
        <div class="absolute left-1/2 top-[-12rem] h-96 w-96 -translate-x-1/2 rounded-full bg-brand-200/60 blur-3xl"></div>
        <div class="absolute right-[-10rem] top-1/2 h-80 w-80 -translate-y-1/2 rounded-full bg-sky-200/60 blur-3xl"></div>
        <div class="relative mx-auto max-w-6xl px-4 py-16 sm:px-6 lg:py-20">
            <div class="flex flex-col gap-10 lg:flex-row lg:items-start">
                <div class="max-w-3xl">
                    <span class="badge bg-brand-100 text-brand-700"><%= software.name %></span>
                    <div class="mt-6 flex items-center gap-4">
                        <h1 class="font-display text-4xl font-semibold tracking-tight text-slate-900 sm:text-5xl">
                            <%= plugin.name %>
                        </h1>
                        <% if (isOwner || (user != null && user.admin)) { %>
                        <a href="/editPlugin/<%= software.url %>/<%= plugin.name %>/<%= plugin.id %>" class="inline-flex items-center justify-center rounded-full border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-slate-600 transition hover:border-brand-300 hover:text-brand-700">
                            Edit
                        </a>
                        <% } %>
                    </div>
                    <div class="mt-4 flex flex-wrap items-center gap-4 text-sm text-slate-500">
                        <span>
                            by <a class="font-semibold text-brand-600 hover:text-brand-700" href="/author/<%= plugin.owner %>"><%= plugin.owner %></a>
                        </span>
                        <span class="hidden h-1 w-1 rounded-full bg-slate-300 sm:inline-block"></span>
                    </div>
                </div>
            </div>

            <div class="mt-12 grid gap-4 sm:grid-cols-2">
                <article class="rounded-2xl border border-slate-200 bg-white px-5 py-4 shadow-sm min-w-0">
                    <span class="text-[11px] uppercase tracking-[0.25em] text-slate-400">Servers</span>
                    <div class="mt-4 flex items-baseline gap-2">
                        <span id="serversCurrent" class="font-display text-4xl font-semibold text-slate-900">--</span>
                        <span class="text-[11px] uppercase tracking-[0.2em] text-slate-400">current</span>
                    </div>
                    <div class="mt-3 flex items-center justify-between rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-500">
                        <span class="uppercase tracking-[0.18em]">record</span>
                        <span id="serversRecord" class="font-semibold text-slate-600">--</span>
                    </div>
                </article>
                <article class="rounded-2xl border border-slate-200 bg-white px-5 py-4 shadow-sm min-w-0">
                    <span class="text-[11px] uppercase tracking-[0.25em] text-slate-400">Players</span>
                    <div class="mt-4 flex items-baseline gap-2">
                        <span id="playersCurrent" class="font-display text-4xl font-semibold text-slate-900">--</span>
                        <span class="text-[11px] uppercase tracking-[0.2em] text-slate-400">current</span>
                    </div>
                    <div class="mt-3 flex items-center justify-between rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-500">
                        <span class="uppercase tracking-[0.18em]">record</span>
                        <span id="playersRecord" class="font-semibold text-slate-600">--</span>
                    </div>
                </article>
            </div>
        </div>
    </section>

    <section class="mx-auto mt-16 max-w-6xl px-4 sm:px-6">
        <div class="flex flex-col gap-3 sm:gap-2">
            <h2 class="font-display text-3xl font-semibold text-slate-900">Live charts</h2>
            <p class="text-sm text-slate-500">Hover, zoom, and drill into the data. Updated every 30 minutes.</p>
        </div>
        <div id="charts" class="mt-8 grid gap-8 md:grid-cols-2"></div>

        <div class="mt-14 rounded-3xl border border-slate-200 bg-white/80 p-6 text-sm text-slate-500 shadow-sm">
            Charts powered by <a class="font-semibold text-brand-600 hover:text-brand-700" href="https://www.highcharts.com/" target="_blank" rel="noopener">Highcharts</a>
        </div>
    </section>
</main>

<% include templates/footer.ejs %>

<!-- Scripts -->
<script src="https://code.highcharts.com/stock/6.0.1/highstock.js"></script>
<script src="https://code.highcharts.com/maps/6.0.1/modules/map.js"></script>
<script src="https://code.highcharts.com/6.0.1/modules/exporting.js"></script>
<script src="https://code.highcharts.com/6.0.1/modules/no-data-to-display.js"></script>
<script src="https://code.highcharts.com/6.0.1/modules/drilldown.js"></script>
<script src="https://code.highcharts.com/maps/6.0.1/modules/data.js"></script>
<script src="https://code.highcharts.com/mapdata/custom/world.js"></script>
<script src="/javascripts/charts/themes/chartTheme.js"></script>
<script>
    window.__bstatsCustomLayout = true;
</script>
<script src="/javascripts/charts/charts.js"></script>
<script>
    (function () {
        const numberFormatter = new Intl.NumberFormat();

        function formatValue(value) {
            if (value === undefined || value === null || isNaN(value)) {
                return '--';
            }
            return numberFormatter.format(value);
        }

        function updateMetricCard(containerId, current, record) {
            $('#' + containerId + 'Current').text(formatValue(current));
            $('#' + containerId + 'Record').text(formatValue(record));
        }

        function calculateRecord(data) {
            return data.reduce((acc, point) => Math.max(acc, point[1]), 0);
        }

        window.updatePlayersBadge = function (data) {
            if (!Array.isArray(data) || !data.length) {
                return;
            }
            const current = data[data.length - 1][1];
            const record = calculateRecord(data);
            updateMetricCard('players', current, record);
        };

        window.updateServersBadge = function (data) {
            if (!Array.isArray(data) || !data.length) {
                return;
            }
            const current = data[data.length - 1][1];
            const record = calculateRecord(data);
            updateMetricCard('servers', current, record);
        };

        const chartGrid = $('#charts');
        window.__bstatsCharts = window.__bstatsCharts || null;
        const chartHeights = {
            pie: '18rem',
            line: '24rem',
            map: '30rem',
            bar: '24rem'
        };

        function createChartCard(chartId, chart) {
            let colSpanClass = 'col-span-1';
            let heightKey = 'pie';
            let suffix = 'Pie';
            switch (chart.type) {
                case 'single_linechart':
                    colSpanClass = 'col-span-1 md:col-span-2';
                    heightKey = 'line';
                    suffix = 'LineChart';
                    break;
                case 'simple_map':
                case 'advanced_map':
                    colSpanClass = 'col-span-1 md:col-span-2';
                    heightKey = 'map';
                    suffix = 'Map';
                    break;
                case 'simple_bar':
                case 'advanced_bar':
                    colSpanClass = 'col-span-1 md:col-span-2';
                    heightKey = 'bar';
                    suffix = 'Bar';
                    break;
                case 'simple_pie':
                case 'advanced_pie':
                case 'drilldown_pie':
                default:
                    colSpanClass = 'col-span-1';
                    heightKey = 'pie';
                    suffix = 'Pie';
                    break;
            }

            const card = $('<article>', {
                id: chartId,
                class: colSpanClass + ' rounded-2xl border border-slate-200 bg-white shadow-sm min-w-0'
            });

            const header = $('<div>', {
                class: 'flex items-start justify-between gap-4 px-5 pt-5'
            });

            const meta = $('<div>').addClass('flex flex-col gap-2');
            meta.append($('<h3>', {
                class: 'font-display text-lg font-semibold text-slate-900',
                text: chart.title
            }));
            header.append(meta);

            const permalink = $('<a>', {
                href: '#' + chartId,
                class: 'inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-500 transition hover:border-slate-300 hover:text-slate-600'
            }).append(
                $('<span>').text('Permalink'),
                $('<svg>', {
                    class: 'h-4 w-4 text-current',
                    viewBox: '0 0 24 24',
                    fill: 'none',
                    xmlns: 'http://www.w3.org/2000/svg'
                }).append(
                    $('<path>', {
                        d: 'M13 4h7v7M11 13l9-9M11 4H6a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-5',
                        stroke: 'currentColor',
                        'stroke-width': '1.5',
                        'stroke-linecap': 'round',
                        'stroke-linejoin': 'round'
                    })
                )
            );
            header.append(permalink);

            const body = $('<div>', { class: 'px-5 pb-6 pt-4' });
            const chartSurface = $('<div>', {
                class: 'overflow-hidden rounded-xl border border-slate-100 bg-slate-50 p-2 sm:p-3 min-w-0'
            });
            const chartContainer = $('<div>', {
                id: chartId + suffix,
                class: 'w-full',
                css: { minHeight: chartHeights[heightKey] || '24rem' }
            });
            chartSurface.append(chartContainer);
            body.append(chartSurface);
            card.append(header, body);
            return { card, suffix };
        }

        $.getJSON('/api/v1/plugins/<%= plugin.id %>/charts', function (charts) {
            const chartIds = Object.keys(charts).sort(function (a, b) {
                return charts[a].position - charts[b].position;
            });

            chartIds.forEach(function (chartId) {
                if (!charts.hasOwnProperty(chartId)) {
                    return;
                }
                const chart = charts[chartId];
                const { card } = createChartCard(chartId, chart);
                chartGrid.append(card);
            });

            window.__bstatsCharts = charts;
            $(document).trigger('bstats:charts-shell-ready', [charts]);

            if (window.location.hash) {
                const target = $(window.location.hash);
                if (target.length) {
                    $('html, body').animate({
                        scrollTop: target.offset().top - 120
                    }, 800);
                }
            }
        });
    })();
</script>
<script>
    function getPluginId() {
        return "<%= plugin.id %>";
    }
</script>

<% include templates/globalScripts.ejs %>

</body>
</html>
