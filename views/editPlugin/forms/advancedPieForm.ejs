<div class="depending_box advanced_pie hidden rounded-2xl border border-white/10 bg-white/5 p-6">
    <form id="advanced_pie_form" class="space-y-6" onsubmit="event.preventDefault(); createAdvancedPieChart();">
        <div class="grid gap-4 sm:grid-cols-2">
            <div>
                <label for="chart_title_advanced_pie" class="block text-sm font-medium text-slate-200">Chart title</label>
                <input id="chart_title_advanced_pie" name="chartTitle" type="text" maxlength="32" pattern="^[-_a-zA-Z0-9]+(\s[-_a-zA-Z0-9]+)*$" required class="input-shell focus-accent mt-2 w-full" placeholder="Votes by type" />
            </div>
            <div>
                <label for="chart_id_advanced_pie" class="block text-sm font-medium text-slate-200">Chart ID</label>
                <input id="chart_id_advanced_pie" name="chartId" type="text" maxlength="32" pattern="^[-_a-zA-Z0-9]+([-_a-zA-Z0-9]+)*$" required class="input-shell focus-accent mt-2 w-full" placeholder="votes_type" />
            </div>
        </div>

        <div>
            <label for="advanced_pie_max_value" class="block text-sm font-medium text-slate-200">Max value per slice (optional)</label>
            <input id="advanced_pie_max_value" name="maxValue" type="number" min="0" class="input-shell focus-accent mt-2 w-full" placeholder="Leave empty for no cap" />
        </div>

        <div class="rounded-xl border border-white/10 bg-slate-900/60 p-4">
            <label class="inline-flex items-center gap-3 text-sm font-semibold text-white">
                <input class="checkboxFilter h-4 w-4 rounded border-white/30 bg-slate-900 text-[var(--accent-color)] focus:ring-2 focus:ring-[var(--accent-color)]" type="checkbox" name="filterEnabled">
                Filter data
            </label>
            <div class="filterOptions mt-4 space-y-4 border-t border-white/10 pt-4 hidden">
                <label class="inline-flex items-center gap-3 text-sm text-slate-300">
                    <input class="checkboxBlacklist h-4 w-4 rounded border-white/30 bg-slate-900 text-[var(--accent-color)] focus:ring-2 focus:ring-[var(--accent-color)]" type="checkbox" name="blacklistEnabled">
                    Treat list as blacklist
                </label>
                <label class="inline-flex items-center gap-3 text-sm text-slate-300">
                    <input class="h-4 w-4 rounded border-white/30 bg-slate-900 text-[var(--accent-color)] focus:ring-2 focus:ring-[var(--accent-color)]" type="checkbox" name="regexEnabled">
                    Use regular expressions
                </label>
                <div>
                    <p class="text-xs text-slate-400"><span class="whitelistLabel">Whitelist entries</span><span class="blacklistLabel hidden">Blacklist entries</span> (one per line):</p>
                    <textarea id="advanced_pie_filter" class="input-shell focus-accent mt-2 w-full text-sm" rows="3" placeholder="value_one&#10;value_two"></textarea>
                </div>
            </div>
        </div>

        <button type="submit" class="accent-bg w-full rounded-full px-6 py-3 text-sm font-semibold shadow-lg shadow-slate-950/40 transition hover:shadow-xl">Create chart</button>
    </form>
</div>

<script>
    $('#chart_title_advanced_pie').on('input', function () {
        $('#chart_id_advanced_pie').val($(this).val().toLowerCase().replace(/[^-_a-z0-9]+/g, '_'));
    });

    window.createAdvancedPieChart = function() {
        var form = $('#advanced_pie_form');
        var filterRaw = $('#advanced_pie_filter').val() || '';
        var filter = filterRaw.split(/\r?\n/).map(function(item) {
            return item.trim();
        }).filter(Boolean);

        addChart({
            chartTitle: $('#chart_title_advanced_pie').val(),
            chartId: $('#chart_id_advanced_pie').val(),
            filterEnabled: form.find('input[name="filterEnabled"]').is(':checked'),
            filter: filter,
            maxValue: $('#advanced_pie_max_value').val(),
            regexEnabled: form.find('input[name="regexEnabled"]').is(':checked'),
            blacklistEnabled: form.find('input[name="blacklistEnabled"]').is(':checked'),
            chart_type: 'advanced_pie'
        });
    };
</script>
